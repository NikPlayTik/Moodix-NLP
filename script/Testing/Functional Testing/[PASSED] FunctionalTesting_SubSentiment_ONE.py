
# -*- coding: utf-8 -*-
"""
Functional test for sub-sentiment detection (soft match).

Запуск:
    pytest 2_FunctionalTesting_SubSentiment.py

Перед запуском:
    set MOODIX_MODEL=D:\Laboratary and practical\!Диплом\Model\14 Moodix v0.64\model.keras
    set MOODIX_TOKENIZER=D:\Laboratary and practical\!Диплом\Model\14 Moodix v0.64\tokenizer.pickle
"""
import os, pytest
from Start_AVG import SentimentAnalyzer

MODEL_PATH = os.getenv("MOODIX_MODEL", "model.keras")
TOKENIZER_PATH = os.getenv("MOODIX_TOKENIZER", "tokenizer.pickle")

@pytest.fixture(scope="session")
def analyzer():
    sa = SentimentAnalyzer(MODEL_PATH, TOKENIZER_PATH)
    sa.load_model()
    return sa

# Тестируемые тексты
texts = [
    "Смартфон Samsung Galaxy A55 5G: переоцененный представитель А-серии",
    "К огромному сожалению, для моих глаз обзор новых смартфонов на строке «сенсорный дисплей AMOLED» заканчивается. :(",
    "Что за левый браузер? У меня в Firefox JetStream2 выдаёт 66,7. Octane 2.0 выдаёт 19020. И это базовая Pura 70 с Kirin 9000S1, да без режима максимальной производительности.",
    "В Беларуси достроили самую высокую панельку. Нет, не в Минске",
    "Слабоватый аккумулятор, раз в сутки приходится заряжать в любом случае, даже без использования нагруженных приложений. Еще небольшой минус в расположении дополнительных кнопок на корпусе, польза от них минимальная, можно было обыграть получше их возможности",
    "Очень удобный в пользовании. Камера и экран супер. Батарея по сравнению с СЕ 2020 кажется не садится.",
    "Приобрела айфон 16 буквально пару дней назад. Ранее пользовалась 13 мини. Что хочу сказать? Этот телефон шикарен. Да, это не про версия, тут нет третьей камеры и 120 Гц. Но если смотреть правде в глаза, это не всем и нужно. Мне все кричали в три голоса взять про-шку, но меня зацепила 16-тка бирюзовая. Телефон мощный, камеры усовершенствовали, появились новые фишки с новыми кнопками, динамический остров добавляет комфорта в использовании. Мне все нравится, очень удобный и классный телефон. Думала перейти с айфона на андроид, но пришла к выводу, что даже суперфлагманы работают хуже базовых новых айфонов, а стоят намного дороже.",
    "Ужасный телефон не стоит своих денег. Достоинства: их в принципе нет. Недостатки: очень быстро нагревается процессор при обычном использовании",
    "Сильно разочарован этим устройством на фоне даже того же SGS23U. Радости не было предела, когда наконец довели до ума частоту ШИМ, вместе с этим были надежды, что исправили проблему отображения белого при наклонах экрана, то есть углы обзора. Начитавшись хвалебных обзоров наконец ломанулся в магазин что бы купить это великолепное устройство по всем обзорам и по многим отзывам, но что в итоге? Спасибо за частоту ШИМ, спасибо за поляризационную пленку, но углы обзора стали ещё хуже, чем были во всех флагманах этой линейки, теперь белый уходит в синий при самом малом отклонении устройства в сторону, при большем уходит в радугу, кроме этого очень неравномерная заливка белого на экране, даже если смотреть на него прямо в упор. Казалось бы, Самсунг впихнул в свое детище передовой экран новейшего поколения, продает свои экраны другим производителям, в которых всех этих проблем нет, что же с самсунгом не так? Конуренты с экранами ВОЕ предлагают сегодня практически идеальный баланс белого не в зависимости от угла обзора и при этом гибкую настройку цветопередачи на вкус каждого, в т.ч. и бб. Ярким экран тоже не назвать, на 'экстремальная яркость' в прямом сравнении не ярче моего старенького 1+9R, который вышел 3.5 года назад. Без этого костыля и вовсе тусклее. У друга флагманский смартфон из концерта bbk, от экрана глаз не оторвать( А в помещении экран светит, как прожектор. Стилус порезали. Дизайн удешевили, в руках флагман теперь как китайская побрекушка. Очень обидно наблюдать за этой линейкой, которая теряет свой фарм и изюминку, компромиссы, которых с каждым годом все больше и больше",
    "Ужасно! Только зарегистрировался и телефон получил удалённую блокировку UK Samsung Electronics. Стандартно все настраивал, все галочки снимал.",
    "Отличный аппарат. Очень компактный, удобный. Оболочка лучшая. Камера, звук супер.",
    "Перешла с Samsung S10plus. Разницы, кроме того, что батарея лучше, чем у 6-летнего самсунга нет вообще, к тому же на iphone15 не работает дублирование экрана... Не советую, потратьте деньги на чо-нить другое"
]

@pytest.mark.parametrize("text", texts)
def test_sub_sentiment_soft(analyzer, text):
    res = analyzer.analyze_sentiment(text)
    predicted = {k for k, v in res["sub"].items() if v > 0.0}
    assert predicted, f"Нет ни одного sub-сентимента для: {text[:80]}..."
